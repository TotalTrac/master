SET QUOTED_IDENTIFIER, ANSI_NULLS ON
GO
--region [messaging].[PrivateMessagesGetByRecipientListId]

------------------------------------------------------------------------------------------------------------------------
-- Generated By:   dlaub using CodeSmith 6.0.0.0
-- Template:       StoredProcedures.cst
-- Procedure Name: [messaging].[PrivateMessagesGetByRecipientListId]
-- Date Generated: Wednesday, June 7, 2017
------------------------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [messaging].[PrivateMessagesGetStarredBySenderUserIdOrRecipientUserIdPaged] @Id INT,
@PageNumber INT = 1,
@PageSize INT = 10
AS

  SET NOCOUNT ON
  SET TRANSACTION ISOLATION LEVEL READ COMMITTED
  CREATE TABLE #Temp (
    Id INT,

  )
  
   SELECT
    [sub].[Id],
    [sub].[AttachmentListId],
    [sub].[Created],
    [sub].[CreatedById],
    [sub].[IsRead],
    [sub].[IsStarredRecipient],
    [sub].[IsStarredSender],
    [sub].[IsTrashRecipient],
    [sub].[IsTrashSender],
    [sub].[Message],
    [sub].[Modified],
    [sub].[ParentId],
    [sub].[RecipientListId],
    [sub].[SenderUserId],
    [sub].[SentDate],
    [sub].[Subject],
    [sub].[TrashedDateRecipient],
    [sub].[TrashedDateSender],
    [sub].[Rowversion]
  FROM [messaging].[PrivateMessages] sub
  INNER JOIN messaging.RecipientLists rl
    ON rl.MessageId = sub.Id
  WHERE ((sub.IsStarredSender = 1
  AND sub.SenderUserId = @Id)
  OR (rl.RecipientUserId = @Id
  AND sub.IsStarredRecipient = 1))
  AND (sub.IsTrashSender IS NULL
  OR sub.IsTrashSender = 0)

  ORDER BY Id DESC
  OFFSET @PageSize * (@PageNumber - 1) ROWS
  FETCH NEXT @PageSize ROWS ONLY


  SELECT
    COUNT(pm.Id) AS TotalRows FROM messaging.PrivateMessages pm
  INNER JOIN messaging.RecipientLists rl2
    ON rl2.MessageId = pm.Id
  WHERE ((pm.IsStarredSender = 1
  AND pm.SenderUserId = @Id)
  OR (rl2.RecipientUserId = @Id
  AND pm.IsStarredRecipient = 1))
  AND (pm.IsTrashSender IS NULL
  OR pm.IsTrashSender = 0)
--endregion

GO